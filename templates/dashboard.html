<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Reused CSS Link -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <!-- Dashboard CSS Link -->
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">

    <!-- Lottery CSS Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS Link -->
    <link href="https://cdn.bootcss.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS Link for Lottery Modal-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Icon Link-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- JQuery Link -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="{{ url_for('static', filename='js/raffle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/trade.js') }}"></script>

</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand ps-5" href="{{ ('index') }}"><img class="logo" alt="nft-logo" src="{{ url_for('static', filename='images/logo.png') }}">Virtual NFT Market</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end pe-5" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{{ url_for('index') }}"><b>Home</b></a >
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('marketplace') }}"><b>Marketplace</b></a > 
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}"><b>Log out</b></a >
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- echo flash message -->
    <div class="container col-8 text-center">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
        {% endwith %}
    </div>    

     <!-- User info -->
    <div class="user-info">
        <h1 class="mt-5 mb-5 text-center">Dashboard</h1>
        <div class="info-head mb-5">
            <div class="d-flex align-items-center justify-content-center flex-column">
                <div class="mb-3">
                    <img src="{{ url_for('static', filename='images/seller8.png') }}" class="user-img d-block">
                </div>
            </div>
            <h3 class="text-center">Hello {{ current_user.username }},welcome to dashboard!</h3>
            <h4 class="text-center">Balance:{{ '%.2f'|format(current_user.balance) }} ETH</h4> 
        </div>
        <!-- User Nav Section -->
        <div class="container nav-container"> 
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#my-trade">Trade History</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#my-fragments">My Fragments</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#my-collection">My Collection</a>
                </li>
            </ul>
            <!-- nav tab content -->
            <div class="tab-content">
                <!-- my trade -->
                <div id="my-trade" class="container tab-pane active"><br>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Frag-Id</th>
                                <th>Frag-Name</th>
                                <th>Price</th>
                                <th>Date</th>
                                <th>Seller</th>
                            </tr>
                        </thead>
                        <tbody id="trades">
                            {% for trade in trade_history %}
                                <tr style="height: 50px;">
                                    <td>{{ trade.frag_id }}</td>
                                    <td>{{ trade.frag_name }}</td>
                                    <td>{{ '%.2f'|format(trade.price) }}</td>
                                    <td>{{ trade.transaction_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ trade.seller_username }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- My Fragments -->
                <div id="my-fragments" class="container tab-pane fade"><br>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Images</th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody id="fragments">
                            {% for fragment in fragments %}
                                <tr data-bs-toggle="modal" data-bs-target="#myFragmentModal" data-id="{{ fragment.id }}" data-name="{{ fragment.name }}" data-name="{{ fragment.name }}" data-status="{{ fragment.trade_price[0] }}" data-price="{{ fragment.trade_price[1] }}">
                                    <td><img class="trade-img" src="{{ fragment.path }}"></td>
                                    <td>{{ fragment.id }}</td>
                                    <td>{{ fragment.name }}</td>
                                    <td>{{ fragment.trade_price[0] }}</td>
                                    <td>{% if fragment.trade_price[0] == 'For Sale' %}{{ fragment.trade_price[1] }}{% else %}{% endif %}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Fragment Model -->
                    <div class="modal fade" id="myFragmentModal">
                        <div class="modal-dialog">
                            <div class="modal-content">

                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalLabel">Fragment Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>

                                <div class="modal-body">
                                    <p>Name: <span id="modalFragmentName"></span></p>
                                    <p>Status: <span id="modalFragmentStatus"></span></p>
                                    <div id="priceContainer" style="display: none;">
                                        <p>Price: <span id="modalFragmentPrice"></span></p>
                                    </div>
                                    <div class="form-group">
                                        <label for="fragmentStatus">Change Status:</label>
                                        <select id="fragmentStatus" class="form-control">
                                            <option value="not_for_sale">Not For Sale</option>
                                            <option value="for_sale">For Sale</option>
                                        </select>
                                    </div>
                                    <div class="form-group mt-3" id="priceGroup" style="display: none;">
                                        <label for="newPrice">New Price:</label>
                                        <input type="number" id="newPrice" class="form-control" min="0" step="1">
                                    </div>
                                    <!-- Hidden input to store data -->
                                    <input type="hidden" id="currentUserId" value="{{ current_user.id }}">
                                    <input type="hidden" id="fragment-id" value="">
                                    <input type="hidden" id="fragment-status" value="">
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" id="saveChangesButton">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- My collection -->
                <div id="my-collection" class="container tab-pane fade"><br>
                    <div class="row mt-5 mb-5">
                        {% for nft in collections %}
                            {% if loop.index0 % 3 == 0 and not loop.first %}
                                </div>
                                <div class="row mt-5 mb-5">
                            {% endif %}
                            <div class="col-sm-3 col-md-3">
                                <div class="card">
                                    <img src="{{ nft.path }}" class="card-img-top" alt="{{ nft.name }} nft">
                                    <span style="display: block; text-align: center; font-weight: bold; margin-top: 10px;">{{ nft.name.upper() }}</span>
                                </div>
                            </div>
                        {% endfor %}
                        {% if collections|length % 3 != 0 %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lottery -->
    <div class="container lottery-block">
        <div class="row justify-content-center">
            <div class="col-sm-5 d-flex align-items-start justify-content-center lottery-text">
                <div class="lottery-title-container">
                    <h2 class="lottery-title mb-10">
                        <span>L</span>
                        <span>O</span>
                        <span>T</span>
                        <span>T</span>
                        <span>E</span>
                        <span>R</span>
                        <span>Y</span>
                    </h2>
                    <p class="lottery-intro">
                        Want to collect some rare fragments?
                        <br>
                        Spend 10 ETH each time to participate in our lottery!
                        <br> 
                        Collect a complete set of fragments to redeem rewards! 
                        <br>
                        Click on the image on the right to join the lottery now!
                    </p>
                </div>
            </div>
            <!-- Spin Wheel -->
            <div class="lottery-container col-sm-5">
                <div class="spin-wheel">
                    <div class="one">1</div>
                    <div class="two">2</div>
                    <div class="three">3</div>
                    <div class="four">4</div>
                    <div class="five">5</div>
                    <div class="six">6</div>
                </div>
                <span class="wheel-center"></span>
                <button type="button" id="spin" class="btn btn-primary">Spin</button>
                <div class="stopper"></div>
            </div>
        </div>


        <!-- Raffle Modal -->
        <div class="modal fade" id="raffleModal" tabindex="-1" aria-labelledby="raffleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="raffleModalLabel">Congratulations!</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center p-4">
                        <p>You've won a piece!</p >
                        <img id="winningSplitImage" src="" alt="Winning Split" class="img-fluid rounded mb-3"> 
                        <p id="winningSplitName" class="fw-bold"></p >
                    </div>
                    <div class="modal-footer justify-content-center">
                        <!-- Added data-bs-dismiss attribute to ensure this button also can close the modal -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white"> <!-- Changed bg-danger to bg-primary -->
                        <h5 class="modal-title" id="errorModalLabel">Error</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center p-4">
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="errorMessage">Error message will appear here.</span>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>       
    </div>
    
    <!-- Footer -->
    <footer class="bg-light text-center text-lg-start">
        <div class="container p-4">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Balance</h5>
                    <p>
                        Balance offers a platform to trade and collect virtual NFTs. We are dedicated to providing a secure and engaging environment for our users.
                    </p>
                </div>
                <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Links</h5>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="{{ url_for('about') }}" class="text-dark">About Us</a>
                        </li>
                        <li>
                            <a href="{{ url_for('terms') }}" class="text-dark">Terms of Service</a>
                        </li>
                        <li>
                            <a href="{{ url_for('privacy') }}" class="text-dark">Privacy Policy</a>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Follow Us</h5>
                    <ul class="list-unstyled">
                        <li>
                            <a href="#!" class="text-dark">Twitter</a>
                        </li>
                        <li>
                            <a href="#!" class="text-dark">Facebook</a>
                        </li>
                        <li>
                            <a href="#!" class="text-dark">Instagram</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="text-center p-3" style="background-color: #f0f0f0;">
            © 2024 Balance, Inc. All rights reserved.
        </div>
    </footer>
    <!-- Lottery Spin Wheel JS Link-->
    <script src="{{ url_for('static', filename='js/spin.js') }}"></script>
</body>
</html>
